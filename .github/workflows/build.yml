name: Build Strapi for Linux
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Clean previous installation
        run: |
          rm -rf node_modules
          rm -f package-lock.json
          npm cache clean --force

      - name: Create .npmrc with correct config
        run: |
          cat > .npmrc << 'EOF'
          engine-strict=true
          legacy-peer-deps=true
          save-exact=true
          EOF

      - name: Install Strapi core first
        run: npm install @strapi/strapi@4.24.1 --no-optional --legacy-peer-deps

      - name: Install other dependencies
        run: npm install @strapi/plugin-users-permissions@4.24.1 @strapi/plugin-upload@4.24.1 --no-optional --legacy-peer-deps

      - name: Apply ajv patch if needed
        run: |
          # Устанавливаем правильную версию ajv
          npm install ajv@^8.12.0 ajv-draft-04@^4.0.0 --no-save
          # Проверяем, что установилось
          npm list ajv ajv-draft-04

      - name: Build Strapi
        run: npm run build

      - name: Upload Linux build
        uses: actions/upload-artifact@v4
        with:
          name: strapi-linux-build
          path: dist/
